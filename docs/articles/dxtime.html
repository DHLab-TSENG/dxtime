<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> • dxtime</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="">
<meta property="og:description" content="dxtime">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dxtime</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dxtime.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="dxtime_files/header-attrs-2.5/header-attrs.js"></script><link href="dxtime_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="dxtime_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Getting started with dxtime</h1>
                        <h4 class="author">Yi-An, Chu</h4>
            
            <h4 class="date">2021-07-17</h4>
      
      
      <div class="hidden name"><code>dxtime.Rmd</code></div>

    </div>

    
    
<div id="安裝套件" class="section level2">
<h2 class="hasAnchor">
<a href="#%E5%AE%89%E8%A3%9D%E5%A5%97%E4%BB%B6" class="anchor"></a>安裝套件</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span>
<span class="co"># Install development version from GitHub</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"DHLab-TSENG/dxtime"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">dxtime</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package 'C:/Users/anay1/Desktop/R/dxtime' is not available for this version of R
## 
## A version of this package for your version of R might be available elsewhere,
## see the ideas at
## https://cran.r-project.org/doc/manuals/r-patched/R-admin.html#Installing-packages</code></pre>
<pre><code>## Warning: replacing previous import 'data.table::transpose' by 'purrr::transpose'
## when loading 'dxtime'</code></pre>
</div>
<div id="範例資料" class="section level2">
<h2 class="hasAnchor">
<a href="#%E7%AF%84%E4%BE%8B%E8%B3%87%E6%96%99" class="anchor"></a>範例資料</h2>
<p>以下功能介紹皆以<code>pat_dm</code>以及<code>record_dm</code>做為範例。<br>
pat_dm中共200名個案，170位病例組(label=1)，30位為對照組(label=0);<br>
record_dm為該200名個案在指標日(發生疾病/最後一筆…)的之診斷紀錄。</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">pat_dm</span><span class="op">)</span>
<span class="co">#&gt;    ID   birthday gender label age</span>
<span class="co">#&gt; 1:  1 1956-03-18      F     0  50</span>
<span class="co">#&gt; 2:  2 1976-04-26      M     0  42</span>
<span class="co">#&gt; 3:  3 1950-06-02      M     0  68</span>
<span class="co">#&gt; 4:  4 1984-10-21      M     0  33</span>
<span class="co">#&gt; 5:  5 1944-08-01      M     0  74</span>
<span class="co">#&gt; 6:  6 1982-11-27      M     0  32</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">record_dm</span><span class="op">)</span>
<span class="co">#&gt;     ID       date  ICD</span>
<span class="co">#&gt; 1: 149 2015-07-08 4019</span>
<span class="co">#&gt; 2: 149 2015-07-08 2720</span>
<span class="co">#&gt; 3: 149 2015-07-08 7840</span>
<span class="co">#&gt; 4: 149 2015-09-30 4019</span>
<span class="co">#&gt; 5: 149 2015-09-30 2720</span>
<span class="co">#&gt; 6: 149 2015-09-30 7840</span></code></pre></div>
</div>
<div id="使用流程" class="section level2">
<h2 class="hasAnchor">
<a href="#%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B" class="anchor"></a>使用流程</h2>
<p><img src="https://raw.githubusercontent.com/DHLab-TSENG/dxtime/main/image/overview.png"><br><img src="https://raw.githubusercontent.com/DHLab-TSENG/dxtime/main/image/timeline.png"> ## 功能說明 ### 一、篩選符合研究長度之個案及診斷紀錄</p>
<p>在病例對照研究，會探討回溯期間內的暴露因子與疾病發生的關係。隨著回溯時間長度越長，所囊括的暴露的危險因子會越多，樣本比較之下，將會造成「回溯時長較長的樣本，危險因子較多」的偏誤。<br>
為避免這種偏誤，固定追蹤時長是較佳的作法。但每個樣本的發病日期(indexDate)並不相同，在filterCasesRecords()可回推追蹤時間，找出追蹤時間範圍內的診斷資料；此外，資料長度不足的樣本也可將之排除。</p>
<p>主要需設定的參數有:<br><code>predictGap</code>: 預測天數，意指「想要於指標日多久前進行預測」。<br><code>exposurePeriod</code>：此研究所設定的危險因子暴露時長，將用於篩選時間範圍內的診斷紀錄。<br><code>includePeriodAtLeast</code>：病患須擁有的資料長度下限。結果將依設定將資料長度不足的個案於以排除，預設為0。<br><code>countICDAtLeast</code>：病患須擁有的資料筆數下限，若是診斷紀錄的筆數過少，有可能意味著該個案極少至此醫療單位看診，研究者可設定診斷紀錄的數量下限，來決定是否採納此個案之紀錄，預設為0。<br><code>align</code>：設定納入資料的方式，是由起始點往後(align=“left”)，或是預測點往回推(align=“right”)，預設為right。</p>
<p>執行結束會產生兩種結果，分別是Patient(病患資料)及Record(診斷資料)。</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#dxData &lt;- merge(record_dm,pat_dm[,c("ID","label")],by="ID",all.x=T)</span>
<span class="va">length</span> <span class="op">&lt;-</span> <span class="fu">filterCasesRecords</span><span class="op">(</span>DataFile <span class="op">=</span> <span class="va">record_dm</span>,
                             idColName <span class="op">=</span> <span class="va">ID</span>,
                             icdColName <span class="op">=</span> <span class="va">ICD</span>,
                             dateColName <span class="op">=</span> <span class="va">date</span>,
                             predictGap <span class="op">=</span> <span class="fl">180</span>, 
                             exposurePeriod <span class="op">=</span> <span class="fl">1800</span>, 
                             includePeriodAtLeast <span class="op">=</span> <span class="fl">360</span>, 
                             countICDAtLeast <span class="op">=</span> <span class="fl">2</span>,
                             align<span class="op">=</span><span class="st">"right"</span>
                             <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">length</span><span class="op">$</span><span class="va">Patient</span><span class="op">)</span> 
<span class="co">#&gt;     ID  firstDate predictDate  indexDate includePeriod countICD  cri</span>
<span class="co">#&gt; 1: 149 2002-03-05  2018-04-27 2018-10-24          5897      167 TRUE</span>
<span class="co">#&gt; 2: 196 2006-10-21  2017-01-30 2017-07-29          3754      106 TRUE</span>
<span class="co">#&gt; 3:  61 2001-05-13  2017-07-16 2018-01-12          5908       57 TRUE</span>
<span class="co">#&gt; 4: 142 2001-02-09  2018-04-08 2018-10-05          6267     1020 TRUE</span>
<span class="co">#&gt; 5:  98 2002-01-11  2004-01-08 2004-07-06           727      191 TRUE</span>
<span class="co">#&gt; 6:   5 2014-01-16  2018-02-21 2018-08-20          1497      158 TRUE</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">length</span><span class="op">$</span><span class="va">Record</span><span class="op">)</span> 
<span class="co">#&gt;     ID  ICD       date</span>
<span class="co">#&gt; 1: 149 4019 2015-07-08</span>
<span class="co">#&gt; 2: 149 2720 2015-07-08</span>
<span class="co">#&gt; 3: 149 7840 2015-07-08</span>
<span class="co">#&gt; 4: 149 4019 2015-09-30</span>
<span class="co">#&gt; 5: 149 2720 2015-09-30</span>
<span class="co">#&gt; 6: 149 7840 2015-09-30</span></code></pre></div>
<p>以上框結果說明：</p>
<p>第一種結果<strong>Patient</strong>，該資料表顯示三個時間點，firstDate、predicDate、indexDate。 firstDate為第一筆診斷紀錄的日期；predictDate為預測資料的最後一個預測時間點，也就是indexDate-exposurePeriod；indexDate為最後一筆資料的時間點。 includePeriod計算該個案在predictDate之前的資料長度，而count計算該個案的診斷紀錄筆數，如符合研究設定的篩選條件(includePeriod&gt;includePeriodAtLeast &amp; count&gt;count_limit)的個案，在cri顯示TRUE，反之則為FALSE。</p>
<p>第二種資料<strong>Record</strong>，從符合個案的資料中，篩選出符合研究長度(exposurePeriod)的診斷紀錄。</p>
<div id="二配對個案" class="section level3">
<h3 class="hasAnchor">
<a href="#%E4%BA%8C%E9%85%8D%E5%B0%8D%E5%80%8B%E6%A1%88" class="anchor"></a>二、配對個案</h3>
<p>避免干擾因子的影響，研究者可將重要的人口學特徵，例如:性別、年齡、種族等等進行配對，使對照組的人口學特徵的分布與病例組相似。在matchCases()能使用兩種方法進行配對。<br>
第一為method=“derict”，直接將干擾變數的條件相同者進行配對<br>
第二為method=“pscore”，傾向配對法，將配對變數置入羅吉斯回歸中，得到所有干擾因子的發病機率pscore，最後以pscore相同者配對，找出匹配病例組的對照組。<br>
使用者須給定要匹配的變量以及label。將匹配變量以向量輸入至<code>matchedVariable</code>參數。結果會輸出被配對到個個案以及傾向配對分數。</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">match</span> <span class="op">&lt;-</span> <span class="fu">matchCases</span><span class="op">(</span>DataFile <span class="op">=</span> <span class="va">pat_dm</span>,
                    idColName <span class="op">=</span> <span class="va">ID</span>,
                    labelColName <span class="op">=</span> <span class="va">label</span>,
                    matchedVariableColName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>,<span class="st">"gender"</span><span class="op">)</span>,
                    method <span class="op">=</span> <span class="st">"pscore"</span>,
                    ratio <span class="op">=</span> <span class="fl">5L</span>
                    <span class="op">)</span>
<span class="co"># match &lt;- matchCases(DataFile = pat_dm %&gt;% filter(pat_dm$ID %in% length$DataFile_pat$ID),</span>
<span class="co">#                     idColName = ID,</span>
<span class="co">#                     labelColName = label,</span>
<span class="co">#                     matchedVariable = c("age","gender"))</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">match</span><span class="op">)</span>
<span class="co">#&gt;    ID label age gender    pscore subclass</span>
<span class="co">#&gt; 1:  1     0  50      F 0.0932471       28</span>
<span class="co">#&gt; 2:  2     0  42      M 0.1534463       11</span>
<span class="co">#&gt; 3:  3     0  68      M 0.1885943       17</span>
<span class="co">#&gt; 4:  4     0  33      M 0.1425958        9</span>
<span class="co">#&gt; 5:  5     0  74      M 0.1975325       16</span>
<span class="co">#&gt; 6:  6     0  32      M 0.1414306       13</span>
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">match</span><span class="op">)</span>
<span class="co">#&gt; [1] 180</span></code></pre></div>
</div>
<div id="三切分時間窗" class="section level3">
<h3 class="hasAnchor">
<a href="#%E4%B8%89%E5%88%87%E5%88%86%E6%99%82%E9%96%93%E7%AA%97" class="anchor"></a>三、切分時間窗</h3>
<p>隨著追蹤的時間點不同，其他疾病與觀察疾病的相關程度會有所不同，使用cutWindow()能將追蹤期間切分為數個時間窗，依照時間窗呈現出樣本罹患所有疾病的狀況，並且以grouped code的方式，將ICD以CCS分類，最後以二元碼的方式呈現。<br>
在劃分時間窗時，除了群組編碼的轉換，也能進行年齡計算，由於年齡會隨時間變化，同一個樣本在不同時間窗的年齡會隨之推移，因此cutWindow()可在切分時間窗時一併進行窗內年齡的計算，最後可選擇以二元碼(預設以45歲為分界)或以實際數值的型態呈現。</p>
<p>主要需設定的參數有:<br><code>birthdayColName</code>:此參數為計算年齡需使用到的參數，可利用birthday計算出的每個時間窗的年齡periodage並以數字型態呈現，若需要以二元形式呈現，可用<code>binaryage=T</code>，預設會以45歲為分界，也可以使用<code>agelayer</code>自行設定分界。若輸入資料沒包含生日，則不會進行區間年齡的計算。 <code>N</code>：設定時間窗數量，注意：若該個案在某時間窗中沒有診斷資料，將會自動補0。<br><code>countICD_toCCS</code>：定義在追蹤期間，多少個疾病診斷碼(ICD)視為該患者具有該疾病(ccs)。</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#forcut &lt;- merge(length$Record %&gt;% filter(ID %in% match$ID),pat_dm[,.(ID,birthday)],all.x=T)</span>
<span class="va">forcut</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">record_dm</span>,<span class="va">pat_dm</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">ID</span>,<span class="va">birthday</span><span class="op">)</span><span class="op">]</span>,all.x<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">forcut</span><span class="op">)</span>
<span class="co">#&gt;    ID       date   ICD   birthday</span>
<span class="co">#&gt; 1:  1 2002-09-14  5649 1956-03-18</span>
<span class="co">#&gt; 2:  1 2002-09-14  2724 1956-03-18</span>
<span class="co">#&gt; 3:  1 2002-09-14 25000 1956-03-18</span>
<span class="co">#&gt; 4:  1 2004-01-31  2500 1956-03-18</span>
<span class="co">#&gt; 5:  1 2004-01-31  2724 1956-03-18</span>
<span class="co">#&gt; 6:  1 2004-01-31  5649 1956-03-18</span>
<span class="va">windowcut</span> <span class="op">&lt;-</span> <span class="fu">cutWindow</span><span class="op">(</span>DataFile <span class="op">=</span> <span class="va">forcut</span> , 
                       idColName <span class="op">=</span> <span class="va">ID</span> ,
                       icdColName <span class="op">=</span> <span class="va">ICD</span> , 
                       dateColName <span class="op">=</span> <span class="va">date</span> ,
                       birthdayColName <span class="op">=</span> <span class="va">birthday</span> ,
                       binaryAge <span class="op">=</span> <span class="cn">T</span> ,
                       <span class="co">#ageLayer = 45,</span>
                       predictGap <span class="op">=</span> <span class="fl">180</span> ,
                       window <span class="op">=</span> <span class="fl">360</span> , 
                       N <span class="op">=</span> <span class="fl">5</span> ,
                       countICD_toCCS <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; Wrong ICD format: total 222 ICD codes (the number of occurrences is in brackets)</span>
<span class="co">#&gt; c("585 (944)", "5640 (620)", "2500 (269)", "6009 (224)", "M791 (150)", "5714 (144)", "5210 (125)", "7805 (120)", "V670 (115)", "V048 (114)")</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; Wrong ICD format: total 50 ICD codes (the number of occurrences is in brackets)</span>
<span class="co">#&gt; c("585 (116)", "M791 (89)", "E780 (41)", "E784 (33)", "2500 (23)", "5714 (22)", "E11359 (19)", "V451 (17)", "F328 (15)", "T1490 (15)")</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; Wrong ICD format: total 64 ICD codes (the number of occurrences is in brackets)</span>
<span class="co">#&gt; c("585 (132)", "M791 (61)", "E780 (54)", "E784 (48)", "H3532 (25)", "K0532 (24)", "2500 (22)", "E11359 (16)", "T1490 (16)", "5640 (15)")</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; Wrong ICD format: total 55 ICD codes (the number of occurrences is in brackets)</span>
<span class="co">#&gt; c("585 (175)", "5640 (73)", "0414 (22)", "6009 (22)", "V155 (19)", "2554 (17)", "V135 (17)", "V048 (13)", "E780 (13)", "5888 (12)")</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; Wrong ICD format: total 61 ICD codes (the number of occurrences is in brackets)</span>
<span class="co">#&gt; c("585 (185)", "5640 (111)", "0414 (38)", "V155 (37)", "V135 (35)", "5997 (22)", "6009 (21)", "5234 (16)", "5210 (14)", "V048 (14)")</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; Wrong ICD format: total 38 ICD codes (the number of occurrences is in brackets)</span>
<span class="co">#&gt; c("585 (182)", "5640 (60)", "5210 (34)", "V048 (20)", "6009 (17)", "2740 (11)", "5997 (11)", "2500 (7)", "6000 (7)", "2429 (6)")</span>
<span class="co">#&gt;  </span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">windowcut</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    window_N periodAge  ID ccs_1 ccs_2 ccs_3 ccs_4 ccs_5 ccs_6 ccs_7</span>
<span class="co">#&gt; 1:        1         1   1     0     0     0     0     0     0     0</span>
<span class="co">#&gt; 2:        1         1  10     0     0     0     0     0     0     0</span>
<span class="co">#&gt; 3:        1         1 100     0     0     0     0     0     0     0</span>
<span class="co">#&gt; 4:        1         1 101     0     0     0     0     0     0     0</span>
<span class="co">#&gt; 5:        1         0 102     0     0     0     0     0     0     0</span>
<span class="co">#&gt; 6:        1         0 103     1     0     0     0     0     0     0</span></code></pre></div>
<p>以上述結果說明：<br>
periodAge代表該個案在該時間窗的年紀。1為大於等於45歲；0則反之。<br>
window_N代表時間窗的次序，數字越小越接近指標日；此外window_N為“all”，是不分時間窗時的狀況。 其餘的數字欄位為CCS的編碼，1表示得到疾病，0則反之。</p>
</div>
<div id="四選擇特徵" class="section level3">
<h3 class="hasAnchor">
<a href="#%E5%9B%9B%E9%81%B8%E6%93%87%E7%89%B9%E5%BE%B5" class="anchor"></a>四、選擇特徵</h3>
<p>運用時間窗資料，將所有ccs為預測變數，進行Cox單變量回歸後，選出p-value&lt;0.05 &amp; 得病人數&gt;caseCountRate_limit的特徵；<br>
可以用全長度資料做一次特徵篩選(method = “allWindow”)，也可以做多時間窗(method = “perWindow”)的特徵篩選。</p>
<p>主要需設定的參數有：<br><code>caseCountRate_limit</code>：若罹患某疾病(CCS)的人數過少，可設定最低下限予以限制，避免被篩選為特徵，此參數的單為為比例，因此不得大於1。<br><code>isDescription</code>：輸出結果是否具備ccs的中文描述。<br><code>method</code>: 選取特徵的方法，method = “perWindow”區分時間窗做特徵選取，method = “allWindow”為不區分時間窗的特徵選取。</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">length</span><span class="op">$</span><span class="va">DataFile_rec</span><span class="op">)</span>
<span class="co">#&gt; NULL</span>
<span class="va">record_dm</span> <span class="op">&lt;-</span> <span class="va">record_dm</span>
<span class="va">lengthdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">record_dm</span><span class="op">[</span>,<span class="va">dataLength</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,by<span class="op">=</span><span class="st">"ID"</span><span class="op">]</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">ID</span>,<span class="va">dataLength</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#lengthdata &lt;- unique(length$Record[,dataLength:=max(date)-min(date),by="ID"][,.(ID,dataLength)])</span>
<span class="va">personal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">pat_dm</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">ID</span>,<span class="va">label</span>,<span class="va">gender</span>,<span class="va">age</span><span class="op">)</span>,<span class="op">]</span>,<span class="va">lengthdata</span>,by<span class="op">=</span><span class="st">"ID"</span>,all.x<span class="op">=</span><span class="cn">T</span><span class="op">)</span>

<span class="va">feature</span> <span class="op">&lt;-</span> <span class="fu">selectFeature</span><span class="op">(</span>DataFile_cutData <span class="op">=</span> <span class="va">windowcut</span>,
                         DataFile_personal <span class="op">=</span> <span class="va">personal</span>,
                         idColName <span class="op">=</span> <span class="va">ID</span>,
                         labelColName<span class="op">=</span><span class="va">label</span>,
                         dataLengthColName <span class="op">=</span> <span class="va">dataLength</span>,
                         caseCountRate_limit <span class="op">=</span> <span class="fl">0.001</span>,
                         isDescription <span class="op">=</span> <span class="cn">T</span>,
                         pvalue<span class="op">=</span><span class="fl">0.05</span>,
                         method <span class="op">=</span> <span class="st">"allWindow"</span>
                         <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">feature</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    CCS_CATEGORY    HR Pr(&gt;|z|) caseCount</span>
<span class="co">#&gt; 1:        ccs_1 1.182    0.869         6</span>
<span class="co">#&gt; 2:       ccs_10 0.931    0.894        22</span>
<span class="co">#&gt; 3:      ccs_102 0.409    0.380        13</span>
<span class="co">#&gt; 4:      ccs_104 0.443    0.424        11</span>
<span class="co">#&gt; 5:      ccs_106 0.188    0.100        25</span>
<span class="co">#&gt; 6:      ccs_108 0.000    0.997         2</span>
<span class="co">#&gt;                              CCS_CATEGORY_DESCRIPTION</span>
<span class="co">#&gt; 1:                                       Tuberculosis</span>
<span class="co">#&gt; 2: Immunizations and screening for infectious disease</span>
<span class="co">#&gt; 3:                             Nonspecific chest pain</span>
<span class="co">#&gt; 4:                Other and ill-defined heart disease</span>
<span class="co">#&gt; 5:                               Cardiac dysrhythmias</span>
<span class="co">#&gt; 6:          Congestive heart failure; nonhypertensive</span>
<span class="co">#&gt;                       CCS_LVL_1_LABEL</span>
<span class="co">#&gt; 1:  Infectious and parasitic diseases</span>
<span class="co">#&gt; 2:  Infectious and parasitic diseases</span>
<span class="co">#&gt; 3: Diseases of the circulatory system</span>
<span class="co">#&gt; 4: Diseases of the circulatory system</span>
<span class="co">#&gt; 5: Diseases of the circulatory system</span>
<span class="co">#&gt; 6: Diseases of the circulatory system</span>
<span class="co">#&gt;                                       CCS_LVL_2_LABEL selected</span>
<span class="co">#&gt; 1:                                Bacterial infection    FALSE</span>
<span class="co">#&gt; 2: Immunizations and screening for infectious disease    FALSE</span>
<span class="co">#&gt; 3:                              Diseases of the heart    FALSE</span>
<span class="co">#&gt; 4:                              Diseases of the heart    FALSE</span>
<span class="co">#&gt; 5:                              Diseases of the heart    FALSE</span>
<span class="co">#&gt; 6:                              Diseases of the heart    FALSE</span></code></pre></div>
<p>以上述結果說明： feature涵蓋每個時間窗的篩選結果，有幾個時間窗就有幾個table。<br>
以上圖輸出舉例，HR為風險比率；Pr(&gt;|z|)為p-value；caseCount為該時間窗中共有多少個案患病，最後，若p-value&lt;0.05 &amp; caseCount&gt;caseCountRate_limit*總人數的ccs，會在selected顯示為TRUE。</p>
</div>
<div id="五以cox回歸建立預測模型" class="section level3">
<h3 class="hasAnchor">
<a href="#%E4%BA%94%E4%BB%A5cox%E5%9B%9E%E6%AD%B8%E5%BB%BA%E7%AB%8B%E9%A0%90%E6%B8%AC%E6%A8%A1%E5%9E%8B" class="anchor"></a>五、以COX回歸建立預測模型</h3>
<p>使用grouped codes的方式，用ccs為預測變量進行建模。 需提供三種資料表來進行建模。分別是<br>
1. <strong>DataFile_cutdata</strong>：劃分為時間窗的資料，使用cutWindow function可以獲得；<br>
2. <strong>DataFile_feature</strong>：要放入作為預測變量的特徵；<br>
3. <strong>DataFile_personal</strong>：個案資料，包含ID、label、gender、age，若有需放入一併建模的特徵，也須於此表中提供欄位；</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">windowcut</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    window_N periodAge  ID ccs_1 ccs_2 ccs_3 ccs_4 ccs_5 ccs_6 ccs_7</span>
<span class="co">#&gt; 1:        1         1   1     0     0     0     0     0     0     0</span>
<span class="co">#&gt; 2:        1         1  10     0     0     0     0     0     0     0</span>
<span class="co">#&gt; 3:        1         1 100     0     0     0     0     0     0     0</span>
<span class="co">#&gt; 4:        1         1 101     0     0     0     0     0     0     0</span>
<span class="co">#&gt; 5:        1         0 102     0     0     0     0     0     0     0</span>
<span class="co">#&gt; 6:        1         0 103     1     0     0     0     0     0     0</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">feature</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt;      CCS_CATEGORY    HR Pr(&gt;|z|) caseCount</span>
<span class="co">#&gt;   1:        ccs_1 1.182    0.869         6</span>
<span class="co">#&gt;   2:       ccs_10 0.931    0.894        22</span>
<span class="co">#&gt;   3:      ccs_102 0.409    0.380        13</span>
<span class="co">#&gt;   4:      ccs_104 0.443    0.424        11</span>
<span class="co">#&gt;   5:      ccs_106 0.188    0.100        25</span>
<span class="co">#&gt;  ---                                      </span>
<span class="co">#&gt; 192:       ccs_95 0.913    0.834        42</span>
<span class="co">#&gt; 193:       ccs_96 0.000    0.997         7</span>
<span class="co">#&gt; 194:       ccs_97 0.000    0.997         1</span>
<span class="co">#&gt; 195:       ccs_98 0.415    0.024        93</span>
<span class="co">#&gt; 196:       ccs_99 0.410    0.223        23</span>
<span class="co">#&gt;                                                                                                CCS_CATEGORY_DESCRIPTION</span>
<span class="co">#&gt;   1:                                                                                                       Tuberculosis</span>
<span class="co">#&gt;   2:                                                                 Immunizations and screening for infectious disease</span>
<span class="co">#&gt;   3:                                                                                             Nonspecific chest pain</span>
<span class="co">#&gt;   4:                                                                                Other and ill-defined heart disease</span>
<span class="co">#&gt;   5:                                                                                               Cardiac dysrhythmias</span>
<span class="co">#&gt;  ---                                                                                                                   </span>
<span class="co">#&gt; 192:                                                                                     Other nervous system disorders</span>
<span class="co">#&gt; 193:                                                                                              Heart valve disorders</span>
<span class="co">#&gt; 194: Peri-; endo-; and myocarditis; cardiomyopathy (except that caused by tuberculosis or sexually transmitted disease)</span>
<span class="co">#&gt; 195:                                                                                             Essential hypertension</span>
<span class="co">#&gt; 196:                                                         Hypertension with complications and secondary hypertension</span>
<span class="co">#&gt;                                      CCS_LVL_1_LABEL</span>
<span class="co">#&gt;   1:               Infectious and parasitic diseases</span>
<span class="co">#&gt;   2:               Infectious and parasitic diseases</span>
<span class="co">#&gt;   3:              Diseases of the circulatory system</span>
<span class="co">#&gt;   4:              Diseases of the circulatory system</span>
<span class="co">#&gt;   5:              Diseases of the circulatory system</span>
<span class="co">#&gt;  ---                                                </span>
<span class="co">#&gt; 192: Diseases of the nervous system and sense organs</span>
<span class="co">#&gt; 193:              Diseases of the circulatory system</span>
<span class="co">#&gt; 194:              Diseases of the circulatory system</span>
<span class="co">#&gt; 195:              Diseases of the circulatory system</span>
<span class="co">#&gt; 196:              Diseases of the circulatory system</span>
<span class="co">#&gt;                                         CCS_LVL_2_LABEL selected</span>
<span class="co">#&gt;   1:                                Bacterial infection    FALSE</span>
<span class="co">#&gt;   2: Immunizations and screening for infectious disease    FALSE</span>
<span class="co">#&gt;   3:                              Diseases of the heart    FALSE</span>
<span class="co">#&gt;   4:                              Diseases of the heart    FALSE</span>
<span class="co">#&gt;   5:                              Diseases of the heart    FALSE</span>
<span class="co">#&gt;  ---                                                            </span>
<span class="co">#&gt; 192:                     Other nervous system disorders    FALSE</span>
<span class="co">#&gt; 193:                              Diseases of the heart    FALSE</span>
<span class="co">#&gt; 194:                              Diseases of the heart    FALSE</span>
<span class="co">#&gt; 195:                                       Hypertension     TRUE</span>
<span class="co">#&gt; 196:                                       Hypertension    FALSE</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">personal</span><span class="op">)</span>
<span class="co">#&gt;     ID label gender age dataLength</span>
<span class="co">#&gt; 1:   1     0      F  50  1959 days</span>
<span class="co">#&gt; 2:  10     0      F  71  1673 days</span>
<span class="co">#&gt; 3: 100     0      M  75  1070 days</span>
<span class="co">#&gt; 4: 101     0      M  60  6370 days</span>
<span class="co">#&gt; 5: 102     0      M  45  2367 days</span>
<span class="co">#&gt; 6: 103     0      M  24   672 days</span></code></pre></div>
<p>另外，需設定的參數有：<br><code>predictorColName</code>：除了ccs之外，若是有個案相關資料須一併做為預測變量進行建模，需於此填入變量名稱。並於DataFile_personal提供該變量資料。<br><code>method</code> : 設有兩種方式將各時間區間的結果進行統計計算最後的預測結果，第一為加權的方式，method=“weighting”，第一為投票的方式，method=“vote”。<br>
此外，根據放入的feature，函式自動會使用對應區間的特徵。</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">coxmodel</span> <span class="op">&lt;-</span> <span class="fu">analWindow_Cox</span><span class="op">(</span>DataFile_cutData <span class="op">=</span> <span class="va">windowcut</span>,
                         DataFile_feature <span class="op">=</span> <span class="va">feature</span>,
                         DataFile_personal <span class="op">=</span> <span class="va">personal</span>,
                         idColName <span class="op">=</span> <span class="va">ID</span>,
                         labelColName <span class="op">=</span> <span class="va">label</span>,
                         dataLengthColName <span class="op">=</span> <span class="va">dataLength</span>,
                         predictorColName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender"</span><span class="op">)</span>,
                         isDescription <span class="op">=</span> <span class="cn">T</span>,
                         testN <span class="op">=</span> <span class="fl">3</span>,
                         method<span class="op">=</span><span class="st">"weighting"</span><span class="op">)</span>
<span class="co">#&gt; same features in all windows</span>
<span class="co">#&gt; Error in 1:N: NA/NaN argument</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">coxmodel</span><span class="op">$</span><span class="va">model_table</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; Error in head(coxmodel$model_table[[1]]): object 'coxmodel' not found</span>
<span class="va">coxmodel</span><span class="op">$</span><span class="va">evaluation_test</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'coxmodel' not found</span></code></pre></div>
<p>以上述結果說明：<br>
model_table為各時間區間進行Cox迴歸後的結果。<br>
evaluation_test為統計各時間區間的最終預測結果。</p>
</div>
<div id="六以lstm建立預測模型" class="section level3">
<h3 class="hasAnchor">
<a href="#%E5%85%AD%E4%BB%A5lstm%E5%BB%BA%E7%AB%8B%E9%A0%90%E6%B8%AC%E6%A8%A1%E5%9E%8B" class="anchor"></a>六、以LSTM建立預測模型</h3>
<p>LSTM為RNN中最常使用的模型，運用於做時間序列分析有良好的效果，在運算過程中能自動擷取具影響力的危險因子進行建模。使用analyWindow_LSTM()，使用者可以不需了解tensorflow中複雜的參數，直接根據analyWindow_LSTM()所需的參數進行設定，便可迅速得到以LSTM建立的疾病診斷時序預測模型。 此方法可用於多個時間窗建立預測模型，也可用於單個時間窗建立預測模型。<br>
需提供二種資料表來進行建模。分別是<br>
1. <strong>DataFile_cutdata</strong>：劃分為時間窗的資料，使用cutWindow()可以建構；<br>
2. <strong>DataFile_personal</strong>：個案資料，包含ID、label、gender、age，若有需放入一併建模的特徵，也須於此表格提供；<br>
另外，需設定的參數有：<br><code>predictorColName</code>：除了ccs之外，若是有個案相關資料須一併做為預測變量進行建模，需於此填入變量名稱。並於DataFile_personal提供該變量資料。<br><code>layer</code>: 架構LSTM的重要參數，決定lstm層數，1或2。<br><code>layer1_units</code>:第一層LSTM的神經單元數量，預設為16，常見的還有32、64等。<br><code>layer1_dropout</code>:為避免過擬合，可在每一層訓練完之後，隨機丟棄一些特徵，可以從0至1，常見為0、0.1或0.2。<br><code>layer2_units</code>:若layer設定為2，才需要為第二層設置參數，為神經單元數量，預設為16，常見的還有32、64等。<br><code>layer2_dropout</code>:若layer設定為2，才需要為第二層設置參數。為避免過擬合，可在每一層訓練完之後，隨機丟棄一些特徵，可以從0至1，常見為0、0.1或0.2。<br><code>batch_size</code>：batch size將決定一次訓練的樣本數目，預設為100。<br><code>Epoch</code>：當一個完整的資料集通過了神經網路一次並且返回了一次，這個過程稱為一次epoch，預設為10，表示會從10次epoch中找出經過Validation驗證後找到最佳的迭代次數。</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span>
<span class="co">#set_random_seed(10)</span>
<span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/install_tensorflow.html">install_tensorflow</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Installation complete.</span>
<span class="co"># check version</span>
<span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"keras"</span><span class="op">)</span>
<span class="co">#&gt; [1] '2.4.0'</span>
<span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"tensorflow"</span><span class="op">)</span>
<span class="co">#&gt; [1] '2.4.0'</span>

<span class="va">personal</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender"</span><span class="op">)</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">x</span><span class="op">==</span><span class="st">"F"</span>,<span class="fl">0L</span>,<span class="fl">1L</span><span class="op">)</span><span class="op">)</span>,.SDcols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender"</span><span class="op">)</span><span class="op">]</span>
<span class="co"># lstm &lt;- analWindow_LSTM(DataFile_cutData=windowcut[,-c("periodAge")],</span>
<span class="co">#                          DataFile_personal=personal,</span>
<span class="co">#                          labelColName = label,</span>
<span class="co">#                          predictorColName=c("gender"),</span>
<span class="co">#                          N=3,</span>
<span class="co">#                         batch_size=16,</span>
<span class="co">#                         Epoch=10,</span>
<span class="co">#                         layer=1,</span>
<span class="co">#                         #layer1_dropout = 0.2,</span>
<span class="co">#                         # layer1_units = 16,</span>
<span class="co">#                         # layer2_dropout = 0,</span>
<span class="co">#                         # layer2_units = 16,</span>
<span class="co">#                         # units=16,</span>
<span class="co">#                         testN=2)</span>

<span class="va">lstm</span> <span class="op">&lt;-</span> <span class="fu">analWindow_LSTM2</span><span class="op">(</span>DataFile_cutData<span class="op">=</span><span class="va">windowcut</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"periodAge"</span><span class="op">)</span><span class="op">]</span>,
                         DataFile_personal<span class="op">=</span><span class="va">personal</span>,
                         labelColName <span class="op">=</span> <span class="va">label</span>,
                         predictorColName<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender"</span><span class="op">)</span>,
                         N<span class="op">=</span><span class="fl">3</span>,
                        batch_size<span class="op">=</span><span class="fl">10</span>,
                        Epoch<span class="op">=</span><span class="fl">10</span>,
                        layer<span class="op">=</span><span class="fl">1</span>,
                        layer1_dropout <span class="op">=</span> <span class="fl">0.2</span>,
                        layer1_units <span class="op">=</span> <span class="fl">16</span>,
                        <span class="co"># layer2_dropout = 0,</span>
                        <span class="co"># layer2_units = 16,</span>
                        <span class="co"># units=16,</span>
                        testN<span class="op">=</span><span class="fl">4</span><span class="op">)</span>
<span class="co">#&gt; optimal epoch is  7</span>

<span class="co">## evaluate</span>
<span class="va">model</span> <span class="op">&lt;-</span> <span class="va">lstm</span><span class="op">$</span><span class="va">model</span>
<span class="va">x_test</span> <span class="op">&lt;-</span> <span class="va">lstm</span><span class="op">$</span><span class="va">x_test</span>
<span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">lstm</span><span class="op">$</span><span class="va">y_test</span>
<span class="va">lstm</span><span class="op">$</span><span class="va">evaluation_train</span>
<span class="co">#&gt; [1] 0.7100000 0.6528846 0.6103846 0.6986538 0.6679807</span>
<span class="va">lstm</span><span class="op">$</span><span class="va">evaluation_test</span>
<span class="co">#&gt; [1] 0.7867647 0.8112745 0.7156863 0.6102941 0.7310049</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">model</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">x_test</span>, <span class="va">y_test</span>, batch_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;            [,1]</span>
<span class="co">#&gt; [1,] 0.07285461</span>
<span class="co">#&gt; [2,] 0.19018909</span>
<span class="co">#&gt; [3,] 0.17290056</span>
<span class="co">#&gt; [4,] 0.21653068</span>
<span class="co">#&gt; [5,] 0.09134886</span>
<span class="co">#&gt; [6,] 0.14686477</span></code></pre></div>
</div>
<div id="七視覺化" class="section level3">
<h3 class="hasAnchor">
<a href="#%E4%B8%83%E8%A6%96%E8%A6%BA%E5%8C%96" class="anchor"></a>七、視覺化</h3>
<p>視覺化功能分成三個部分，皆可由前述功能產出的資料直接匯入，輸出視覺化的圖片。</p>
<div id="時間窗視覺化" class="section level4">
<h4 class="hasAnchor">
<a href="#%E6%99%82%E9%96%93%E7%AA%97%E8%A6%96%E8%A6%BA%E5%8C%96" class="anchor"></a>時間窗視覺化</h4>
<p>將各時間窗內的各疾病數量以grouped codes的方式視覺化。<br>
DataFile_cutdata可由cutWindow()的輸出獲得。<br>
需設定的參數有:<br><code>method</code>:可分為“top”和“ccslevel”，top為計算數量並輸出前N名的排行，若method設定為top，則topN也需設定參數；ccslevel是以ccs_level_1為分組進行輸出，若method設定為ccslevel，則需在LVL_1_LABEL輸入cce_level的分類名稱。</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">plotWindow</span><span class="op">(</span>DataFile_cutData <span class="op">=</span> <span class="va">windowcut</span>,
           method<span class="op">=</span><span class="st">"top"</span>,
           <span class="co">#LVL_1_LABEL="Neoplasms",</span>
           topN<span class="op">=</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<p><img src="dxtime_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
<div id="hazard-ratio視覺化" class="section level4">
<h4 class="hasAnchor">
<a href="#hazard-ratio%E8%A6%96%E8%A6%BA%E5%8C%96" class="anchor"></a>Hazard ratio視覺化</h4>
<p>將生存分析後的hazard ratio進行視覺化。<br>
DataFile為從analWindow_Cox的輸出可獲得，pvalue為使用者設定。</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">coxmodel</span><span class="op">$</span><span class="va">model_table</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; Error in head(coxmodel$model_table[[3]]): object 'coxmodel' not found</span>
<span class="fu">plotHR</span><span class="op">(</span>DataFile <span class="op">=</span> <span class="va">coxmodel</span><span class="op">$</span><span class="va">model_table</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>,
       pvalue <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>
<span class="co">#&gt; Error in gsub(pattern = "`", replacement = "", x = DataFile$CCS_CATEGORY): object 'coxmodel' not found</span></code></pre></div>
</div>
<div id="生存區線視覺化" class="section level4">
<h4 class="hasAnchor">
<a href="#%E7%94%9F%E5%AD%98%E5%8D%80%E7%B7%9A%E8%A6%96%E8%A6%BA%E5%8C%96" class="anchor"></a>生存區線視覺化</h4>
<p>可輸出單個類別變數的存活差異，將病例組與對照組的生存曲線進行視覺化。<br>
var中填入使用者要看的ccs category。</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">plotSurv</span><span class="op">(</span>DataFile <span class="op">=</span> <span class="va">record_dm</span>,
         idColName <span class="op">=</span> <span class="va">ID</span>,
         icdColName <span class="op">=</span> <span class="va">ICD</span>,
         dateColName <span class="op">=</span> <span class="va">date</span>,
         DataFile_personal <span class="op">=</span> <span class="va">pat_dm</span>,
         labelColName <span class="op">=</span> <span class="va">label</span>,
         varColName <span class="op">=</span> <span class="st">"Essential hypertension"</span><span class="op">)</span>
<span class="co">#&gt; Error in plotSurv(DataFile = record_dm, idColName = ID, icdColName = ICD, : unused arguments (icdColName = ICD, dateColName = date, varColName = "Essential hypertension")</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by The package maintainer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
